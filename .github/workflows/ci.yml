name: CI

on:
  push:
    branches:
      - 'main'
  pull_request:

jobs:
  ci:
    name: Build PHP ${{ matrix.php-version }}

    runs-on: ubuntu-latest

    continue-on-error: true

    strategy:
      matrix:
        include:
          - php-version: "8.1.13"
            php-package: "php81"
            alpine-version: "3.17.0"
            unit-version: "1.28.0"
            apache2-version: "2.4.54"
          - php-version: "8.0.26"
            php-package: "php8"
            alpine-version: "3.16.3"
            unit-version: "1.26.1"
            apache2-version: "2.4.54"
    steps:
      -   name: "Checkout code"
          uses: actions/checkout@v3

      -   name: "Build Alpine"
          run: ./build_images.sh exozet/draft-docker-php:${{ matrix.php-version }} ${{ matrix.alpine-version }} ${{ matrix.php-version }} ${{ matrix.php-package }} ${{ matrix.unit-version }} ${{ matrix.apache2-version }}

      -   name: "Check Alpine -i"
          run: docker run --rm -t exozet/draft-docker-php:${{ matrix.php-version }}-linux-amd64 php -i

      -   name: "Check Alpine -v"
          run: docker run --rm -t exozet/draft-docker-php:${{ matrix.php-version }}-linux-amd64 php -v

      -   name: Run Alpine Trivy vulnerability scanner
          uses: aquasecurity/trivy-action@master
          with:
            image-ref: 'exozet/draft-docker-php:${{ matrix.php-version }}-linux-amd64'
            format: 'table'
            exit-code: '0' # we don't break the build if vulnerabilities are included!
            ignore-unfixed: true
            vuln-type: 'os,library'
            severity: 'CRITICAL,HIGH'

      -   name: Run Alpine Trivy vulnerability scanner and upload to github security tab
          uses: aquasecurity/trivy-action@master
          with:
            image-ref: 'exozet/draft-docker-php:${{ matrix.php-version }}-linux-amd64'
            format: 'sarif'
            output: 'trivy-results.sarif'

      -   name: Upload Alpine Trivy scan results to GitHub Security tab
          uses: github/codeql-action/upload-sarif@v1
          with:
            sarif_file: 'trivy-results.sarif'
      -   if: contains(github.ref, 'refs/heads/main')
          name: Login to DockerHub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

      -   if: contains(github.ref, 'refs/heads/main')
          name: Login to Quay.io
          uses: docker/login-action@v1
          with:
            registry: quay.io
            username: ${{ secrets.QUAY_USERNAME }}
            password: ${{ secrets.QUAY_PASSWORD }}

      -   if: contains(github.ref, 'refs/heads/main')
          name: "Build and Push Multi Arch PHP ${{ matrix.php-version }}"
          run: ./build_and_push_multi_arch_images.sh exozet/draft-docker-php:${{ matrix.php-version }} ${{ matrix.alpine-version }} ${{ matrix.php-version }} ${{ matrix.php-package }} ${{ matrix.unit-version }} ${{ matrix.apache2-version }}